<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- ヘッダーの読み込み -->
    <div id="header-container" style="position: relative; z-index: 1001"></div>
    <script>
      // ヘッダーを読み込む
      fetch("src/header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("header-container").innerHTML = data;
        });
    </script>

    <div
      id="photo-frame-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
      "
    >
      <img
        src="assets/images/photoFrame.png"
        style="
          width: 100%;
          height: calc(100% - 50px);
          object-fit: cover;
          margin-top: 50px;
        "
      />
    </div>

    <a-scene
      mindar-image="imageTargetSrc: assets/target-images/cookie.mind;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <img id="card" src="assets/target-images/cookie.png" />
        <img id="photoFrame" src="assets/images/photoFrame.png" />
        <a-asset-item
          id="astronautModel"
          src="assets/models/NeilArmstrong.glb"
        ></a-asset-item>
        <a-asset-item
          id="penguinModel"
          src="assets/models/penguinex.glb"
        ></a-asset-item>
        <audio id="soundEffect" src="assets/sounds/celebration.mp3"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane
          src="#card"
          position="0 0 0"
          height="0.552"
          width="1"
          rotation="0 0 0"
        ></a-plane>
        <a-gltf-model
          id="astronautModelEntity"
          rotation="0 -90 0"
          position="0 0 0.1"
          scale="0.5 0.5 0.5"
          src="#astronautModel"
        ></a-gltf-model>
        <a-gltf-model
          id="penguinModelEntity"
          rotation="0 -90 0"
          position="0 0 0.1"
          scale="0.5 0.5 0.5"
          src="#penguinModel"
          visible="false"
        ></a-gltf-model>
      </a-entity>
    </a-scene>
    <div
      class="ui"
      style="
        position: fixed;
        bottom: 20px; /* 画面下からの距離を調整 */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000; /* 他の要素よりも上に表示 */
        background: rgba(
          255,
          255,
          255,
          0.8
        ); /* 背景色を半透明にして視認性を向上 */
        padding: 10px;
        border-radius: 8px;
      "
    >
      <img id="snap" />
      <a href="#" id="delete-photo" title="Delete Photo" class="disabled"
        ><i class="material-icons">delete</i></a
      >
      <a href="" id="take-photo" title="Take Photo"
        ><i class="material-icons">photo_camera</i></a
      >
      <a
        href="#"
        id="download-photo"
        download="selfie.png"
        title="Save Photo"
        class="disabled"
        target="_blank"
        ><i class="material-icons">file_download</i></a
      >
    </div>
    <script>
      let modelLoaded = false;
      let soundPlayed = false;

      const sceneEl = document.querySelector("a-scene");
      sceneEl.addEventListener("arReady", (event) => {
        console.log("MindAR is ready");
      });
      sceneEl.addEventListener("targetFound", (event) => {
        console.log("Target found");
        modelLoaded = true;
        soundPlayed = false;
        updateModel();
      });
      sceneEl.addEventListener("targetLost", (event) => {
        console.log("Target lost");
        soundPlayed = true;
      });

      function updateModel() {
        if (modelLoaded) {
          const soundEffect = document.querySelector("#soundEffect");
          let condition = false;
          const astronautModel = document.querySelector(
            "#astronautModelEntity"
          );
          const penguinModel = document.querySelector("#penguinModelEntity");
          const photoFrameOverlay = document.getElementById(
            "photo-frame-overlay"
          );

          if (condition) {
            astronautModel.setAttribute("visible", true);
            penguinModel.setAttribute("visible", false);
            photoFrameOverlay.style.display = "block";
          } else {
            astronautModel.setAttribute("visible", false);
            penguinModel.setAttribute("visible", true);
            photoFrameOverlay.style.display = "block";
            movePenguin();

            if (!soundPlayed) {
              soundPlayed = true;
              soundEffect.play();
            }
          }
        }
      }

      function movePenguin() {
        const penguin = document.querySelector("#penguinModelEntity");
        let position = 0;
        const speed = 0.01;
        let direction = 1;

        function animate() {
          position += speed * direction;
          if (position > 0.5 || position < -0.5) {
            direction *= -1;
          }
          penguin.setAttribute("position", `0 ${position} 0.1`);
          requestAnimationFrame(animate);
        }

        animate();
      }

      var image = document.querySelector("#snap");
      var take_photo_btn = document.querySelector("#take-photo");
      var delete_photo_btn = document.querySelector("#delete-photo");
      var download_photo_btn = document.querySelector("#download-photo");

      //スナップショットボタン
      take_photo_btn.addEventListener("click", function (e) {
        e.preventDefault();
        var video = document.querySelector("video");
        var snap = takeSnapshot(video);

        //スナップショット表示.
        image.setAttribute("src", snap);
        image.classList.add("visible");

        // 削除ボタンと保存ボタン有効
        delete_photo_btn.classList.remove("disabled");
        download_photo_btn.classList.remove("disabled");

        // 保存ボタンにスナップショットを渡す
        download_photo_btn.href = snap;
      });

      //削除ボタン
      delete_photo_btn.addEventListener("click", function (e) {
        e.preventDefault();

        // スナップショットを隠す
        image.setAttribute("src", "");
        image.classList.remove("visible");

        // 削除ボタンと保存ボタン無効
        delete_photo_btn.classList.add("disabled");
        download_photo_btn.classList.add("disabled");
      });

      //スナップショットを撮る
      function takeSnapshot(video) {
        var resizedCanvas = document.createElement("canvas");
        var resizedContext = resizedCanvas.getContext("2d");
        var width = video.videoWidth;
        var height = video.videoHeight;
        var aScene = document
          .querySelector("a-scene")
          .components.screenshot.getCanvas("perspective");

        if (width && height) {
          //videoのサイズをキャンバスにセット
          resizedCanvas.width = width;
          resizedCanvas.height = height;
          //キャンバスにvideoをコピー
          resizedContext.drawImage(video, 0, 0, width, height);

          //カメラの画角でar側の縮小処理を変える
          if (width > height) {
            // 横長（PC)
            resizedContext.drawImage(aScene, 0, 0, width, height);
          } else {
            // 縦長（スマホ）
            var scale = height / width;
            var scaledWidth = height * scale;
            var marginLeft = (width - scaledWidth) / 2;
            resizedContext.drawImage(
              aScene,
              marginLeft,
              0,
              scaledWidth,
              height
            );
          }
          return resizedCanvas.toDataURL("image/png");
        }
      }
    </script>
  </body>
</html>
